<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script>
        // Direct pinch detection and grab component
        AFRAME.registerComponent('direct-pinch-grab', {
            schema: {
                pinchThreshold: { default: 0.03 },  // Distance between thumb and index to detect pinch
                grabRadius: { default: 0.3 }        // Distance to box to allow grab
            },

            init: function () {
                this.hand = this.el.getAttribute('hand-tracking-controls').hand;
                this.grabbed = null;
                this.grabOffset = new THREE.Vector3();

                // Create debug spheres
                this.indexSphere = document.createElement('a-sphere');
                this.indexSphere.setAttribute('radius', '0.01');
                this.indexSphere.setAttribute('color', 'green');
                this.el.appendChild(this.indexSphere);

                this.thumbSphere = document.createElement('a-sphere');
                this.thumbSphere.setAttribute('radius', '0.01');
                this.thumbSphere.setAttribute('color', 'blue');
                this.el.appendChild(this.thumbSphere);

                // Create distance indicator
                this.distanceIndicator = document.createElement('a-text');
                this.distanceIndicator.setAttribute('value', 'Distance: ?');
                this.distanceIndicator.setAttribute('position', '0 0.1 0');
                this.distanceIndicator.setAttribute('scale', '0.1 0.1 0.1');
                this.distanceIndicator.setAttribute('align', 'center');
                this.el.appendChild(this.distanceIndicator);

                // Get the grabbable box
                this.box = document.querySelector('#grabbable-box');
            },

            tick: function () {
                // Skip if hand tracking isn't active
                if (!this.el.components['hand-tracking-controls'] ||
                    !this.el.components['hand-tracking-controls'].indexTipPosition) {
                    return;
                }

                // Get finger positions
                const indexPos = this.el.components['hand-tracking-controls'].indexTipPosition;
                const thumbPos = this.el.components['hand-tracking-controls'].getJointPose ?
                    this.el.components['hand-tracking-controls'].getJointPose('thumb-tip') :
                    { x: 0, y: 0, z: 0 };

                // Update debug spheres
                this.indexSphere.setAttribute('position', indexPos);
                if (thumbPos) {
                    this.thumbSphere.setAttribute('position', thumbPos);
                }

                // Calculate distance between fingers
                let pinchDistance = 1;
                if (thumbPos) {
                    pinchDistance = Math.sqrt(
                        Math.pow(indexPos.x - thumbPos.x, 2) +
                        Math.pow(indexPos.y - thumbPos.y, 2) +
                        Math.pow(indexPos.z - thumbPos.z, 2)
                    );
                }

                // Update distance indicator
                this.distanceIndicator.setAttribute('value', `Distance: ${pinchDistance.toFixed(3)}`);

                // Determine if pinching
                const isPinching = pinchDistance < this.data.pinchThreshold;

                // Change color based on pinch state
                this.indexSphere.setAttribute('color', isPinching ? 'red' : 'green');
                this.thumbSphere.setAttribute('color', isPinching ? 'red' : 'blue');

                // Calculate hand position (midpoint between fingers)
                const handPos = new THREE.Vector3(
                    (indexPos.x + (thumbPos ? thumbPos.x : indexPos.x)) / 2,
                    (indexPos.y + (thumbPos ? thumbPos.y : indexPos.y)) / 2,
                    (indexPos.z + (thumbPos ? thumbPos.z : indexPos.z)) / 2
                );

                // Calculate distance to box
                const boxPos = new THREE.Vector3();
                this.box.object3D.getWorldPosition(boxPos);
                const distanceToBox = handPos.distanceTo(boxPos);

                // Handle grabbing logic
                if (isPinching) {
                    if (!this.grabbed && distanceToBox < this.data.grabRadius) {
                        // Start grab
                        this.grabbed = this.box;
                        this.grabOffset.copy(boxPos).sub(handPos);
                        this.distanceIndicator.setAttribute('value', `GRABBED! Dist: ${pinchDistance.toFixed(3)}`);
                    }

                    if (this.grabbed) {
                        // Move the grabbed object
                        const targetPos = new THREE.Vector3().copy(handPos).add(this.grabOffset);
                        this.grabbed.object3D.position.copy(targetPos);
                    }
                } else {
                    // Release grab
                    this.grabbed = null;
                }
            }
        });
    </script>
</head>
<body>
    <div id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    <a-scene renderer="antialias: true"
             xr-mode-ui="enabled: true"
             webxr="optionalFeatures: hand-tracking, hit-test, dom-overlay, local-floor, bounded-floor, layers; overlayElement: #overlay;">

        <!-- Box with splat as child -->
        <a-box id="grabbable-box"
               position="-0.351 0.301 -1.065"
               scale="0.2 0.2 0.2"
               material="side: double; color: #EF2D5E; transparent: true; opacity: 0.7">
            <a-entity gaussian_splatting="src: Tate_0.2x.splat;"
                      position="0.157 -0.491 -0.027"
                      rotation="0 12.596 0"
                      scale="0.3 0.3 0.3">
            </a-entity>
        </a-box>

        <!-- Instructions -->
        <a-text value="Pinch your fingers near the box to grab it"
                position="0 1.6 -1"
                scale="0.5 0.5 0.5"
                align="center">
        </a-text>

        <!-- Hand controllers with direct pinch detection -->
        <a-entity hand-tracking-controls="hand: left; modelColor: #ffcccc;"
                  direct-pinch-grab>
        </a-entity>

        <a-entity hand-tracking-controls="hand: right; modelColor: #ffcccc;"
                  direct-pinch-grab>
        </a-entity>

        <!-- Simple environment for reference -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
    </a-scene>
</body>
</html>