<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.5/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script>
        // Debug component to visualize finger positions
        AFRAME.registerComponent('finger-debug', {
            init: function () {
                // Create debug spheres for index fingertips
                this.indexTip = document.createElement('a-sphere');
                this.indexTip.setAttribute('radius', '0.01');
                this.indexTip.setAttribute('color', '#00ff00');
                this.el.appendChild(this.indexTip);

                // Set up event listeners for tracking updates
                this.el.addEventListener('tracked', (evt) => {
                    if (evt.detail.visible) {
                        this.indexTip.setAttribute('visible', true);
                    } else {
                        this.indexTip.setAttribute('visible', false);
                    }
                });
            },

            tick: function () {
                if (this.el.components['hand-tracking-controls'] &&
                    this.el.components['hand-tracking-controls'].indexTipPosition) {
                    const tipPos = this.el.components['hand-tracking-controls'].indexTipPosition;
                    this.indexTip.setAttribute('position', tipPos);
                }
            }
        });

        // Log when hands are detected
        AFRAME.registerComponent('hand-tracking-logger', {
            init: function () {
                console.log(`Hand tracking component initialized for ${this.el.getAttribute('hand-tracking-controls').hand} hand`);

                this.el.addEventListener('hand-tracking-detected', () => {
                    console.log(`Hand tracking detected for ${this.el.getAttribute('hand-tracking-controls').hand} hand`);
                });

                this.el.addEventListener('hand-tracking-lost', () => {
                    console.log(`Hand tracking lost for ${this.el.getAttribute('hand-tracking-controls').hand} hand`);
                });
            }
        });
    </script>
</head>
<body>
    <div id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    <a-scene renderer="antialias: true"
             xr-mode-ui="enabled: true"
             webxr="optionalFeatures: hand-tracking, hit-test, dom-overlay, local-floor, bounded-floor, layers; overlayElement: #overlay;"
             debug>

        <!-- Box with splat as child -->
        <a-box position="-0.351 0.301 -1.065"
               scale="0.2 0.2 0.2"
               material="side: double; color: #EF2D5E; transparent: true; opacity: 0.7"
               class="grabbable"
               grabbable
               hoverable
               draggable>
            <a-entity gaussian_splatting="src: Tate_0.2x.splat;"
                      position="0.157 -0.491 -0.027"
                      rotation="0 12.596 0"
                      scale="0.3 0.3 0.3">
            </a-entity>
        </a-box>

        <!-- Debug text to show hand tracking status -->
        <a-text value="Hand tracking status will appear here"
                position="0 1.6 -1"
                scale="0.5 0.5 0.5"
                align="center"
                id="debug-text"></a-text>

        <!-- Hand controllers with debug visuals -->
        <a-entity hand-tracking-controls="hand: left; modelColor: #ffcccc;"
                  super-hands="colliderEvent: collidestart;
                              colliderEndEvent: collideend;
                              grabStartButtons: gripdown, pinchstart;
                              grabEndButtons: gripup, pinchend"
                  finger-debug
                  hand-tracking-logger>
        </a-entity>

        <a-entity hand-tracking-controls="hand: right; modelColor: #ffcccc;"
                  super-hands="colliderEvent: collidestart;
                              colliderEndEvent: collideend;
                              grabStartButtons: gripdown, pinchstart;
                              grabEndButtons: gripup, pinchend"
                  finger-debug
                  hand-tracking-logger>
        </a-entity>

        <!-- Fallback controller entities in case hand tracking fails -->
        <a-entity oculus-touch-controls="hand: left" visible="false"></a-entity>
        <a-entity oculus-touch-controls="hand: right" visible="false"></a-entity>

        <!-- Simple environment for reference -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
    </a-scene>

    <script>
        // Additional runtime debugging
        window.addEventListener('load', () => {
            const scene = document.querySelector('a-scene');
            const debugText = document.getElementById('debug-text');

            // Update debug text with hand tracking status
            scene.addEventListener('enter-vr', () => {
                debugText.setAttribute('value', 'Entered VR - Checking hand tracking...');

                // Check if hand tracking is available
                if (navigator.xr) {
                    navigator.xr.isSessionSupported('immersive-ar').then(supported => {
                        if (supported) {
                            debugText.setAttribute('value', 'Hand tracking should be available');
                        } else {
                            debugText.setAttribute('value', 'AR not supported on this device');
                        }
                    });
                } else {
                    debugText.setAttribute('value', 'WebXR not available');
                }
            });
        });
    </script>
</body>
</html>