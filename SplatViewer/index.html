<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.5/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script>
        // Debug component to visualize finger positions
        AFRAME.registerComponent('finger-debug', {
            init: function () {
                // Create debug spheres for index fingertips
                this.indexTip = document.createElement('a-sphere');
                this.indexTip.setAttribute('radius', '0.01');
                this.indexTip.setAttribute('color', '#00ff00');
                this.el.appendChild(this.indexTip);

                // Create debug sphere for thumb tip
                this.thumbTip = document.createElement('a-sphere');
                this.thumbTip.setAttribute('radius', '0.01');
                this.thumbTip.setAttribute('color', '#0000ff');
                this.el.appendChild(this.thumbTip);
            },

            tick: function () {
                if (this.el.components['hand-tracking-controls']) {
                    if (this.el.components['hand-tracking-controls'].indexTipPosition) {
                        const tipPos = this.el.components['hand-tracking-controls'].indexTipPosition;
                        this.indexTip.setAttribute('position', tipPos);
                    }

                    if (this.el.components['hand-tracking-controls'].getJointPose) {
                        const thumbPos = this.el.components['hand-tracking-controls'].getJointPose('thumb-tip');
                        if (thumbPos) {
                            this.thumbTip.setAttribute('position', thumbPos);
                        }
                    }
                }
            }
        });

        // Custom pinch-grabber component
        AFRAME.registerComponent('pinch-grabber', {
            schema: {
                pinchDistance: { default: 0.05 },
                grabDistance: { default: 0.2 }
            },

            init: function () {
                this.grabbed = null;
                this.pinching = false;
                this.lastPosition = new THREE.Vector3();

                // Debug text for pinch state
                this.debugText = document.createElement('a-text');
                this.debugText.setAttribute('value', 'Not pinching');
                this.debugText.setAttribute('position', '0 0.1 0');
                this.debugText.setAttribute('scale', '0.1 0.1 0.1');
                this.debugText.setAttribute('align', 'center');
                this.el.appendChild(this.debugText);

                // Listen for pinch events from hand-tracking-controls
                this.el.addEventListener('pinchstarted', this.onPinchStart.bind(this));
                this.el.addEventListener('pinchended', this.onPinchEnd.bind(this));
            },

            onPinchStart: function () {
                this.pinching = true;
                this.debugText.setAttribute('value', 'Pinching!');
                this.debugText.setAttribute('color', 'green');

                // Find closest grabbable object
                const grabbables = document.querySelectorAll('.grabbable');
                let closestDist = this.data.grabDistance;
                let closestGrabbable = null;

                const handPos = new THREE.Vector3();
                this.el.object3D.getWorldPosition(handPos);

                grabbables.forEach(grabbable => {
                    const objPos = new THREE.Vector3();
                    grabbable.object3D.getWorldPosition(objPos);

                    const distance = handPos.distanceTo(objPos);
                    if (distance < closestDist) {
                        closestDist = distance;
                        closestGrabbable = grabbable;
                    }
                });

                if (closestGrabbable) {
                    this.grabbed = closestGrabbable;
                    this.debugText.setAttribute('value', 'Grabbed!');

                    // Store the initial offset
                    this.lastPosition.copy(handPos);
                }
            },

            onPinchEnd: function () {
                this.pinching = false;
                this.debugText.setAttribute('value', 'Not pinching');
                this.debugText.setAttribute('color', 'white');
                this.grabbed = null;
            },

            tick: function () {
                if (this.pinching && this.grabbed) {
                    const handPos = new THREE.Vector3();
                    this.el.object3D.getWorldPosition(handPos);

                    // Calculate movement since last frame
                    const delta = new THREE.Vector3().subVectors(handPos, this.lastPosition);

                    // Apply movement to grabbed object
                    this.grabbed.object3D.position.add(delta);

                    // Update last position
                    this.lastPosition.copy(handPos);
                }
            }
        });
    </script>
</head>
<body>
    <div id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    <a-scene renderer="antialias: true"
             xr-mode-ui="enabled: true"
             webxr="optionalFeatures: hand-tracking, hit-test, dom-overlay, local-floor, bounded-floor, layers; overlayElement: #overlay;"
             debug>

        <!-- Box with splat as child -->
        <a-box position="-0.351 0.301 -1.065"
               scale="0.2 0.2 0.2"
               material="side: double; color: #EF2D5E; transparent: true; opacity: 0.7"
               class="grabbable">
            <a-entity gaussian_splatting="src: Tate_0.2x.splat;"
                      position="0.157 -0.491 -0.027"
                      rotation="0 12.596 0"
                      scale="0.3 0.3 0.3">
            </a-entity>
        </a-box>

        <!-- Debug text to show hand tracking status -->
        <a-text value="Try pinching near the box to grab it"
                position="0 1.6 -1"
                scale="0.5 0.5 0.5"
                align="center"
                id="debug-text"></a-text>

        <!-- Hand controllers with custom pinch grabber -->
        <a-entity hand-tracking-controls="hand: left; modelColor: #ffcccc;"
                  finger-debug
                  pinch-grabber>
        </a-entity>

        <a-entity hand-tracking-controls="hand: right; modelColor: #ffcccc;"
                  finger-debug
                  pinch-grabber>
        </a-entity>

        <!-- Simple environment for reference -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
    </a-scene>
</body>
</html>