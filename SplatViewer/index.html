<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="index.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.5/dist/super-hands.min.js"></script>
    <script>
        AFRAME.registerComponent('pinch-grabbable', {
            schema: {
                distance: { type: 'number', default: 0.02 }, // pinch detection
                grabRadius: { type: 'number', default: 0.1 } // proximity to box to allow grab
            },

            init: function () {
                this.grabbingHand = null;
                this.refSpace = null;
                this.frame = null;
            },

            tick: function () {
                const sceneEl = this.el.sceneEl;
                const renderer = sceneEl.renderer;
                const xr = renderer.xr;

                if (!xr || !xr.isPresenting) return;
                if (!this.refSpace) this.refSpace = xr.getReferenceSpace();
                if (!this.frame) this.frame = sceneEl.frame;
                if (!this.refSpace || !this.frame) return;

                const session = xr.getSession();
                const inputSources = session.inputSources;

                for (const inputSource of inputSources) {
                    if (!inputSource.hand) continue;

                    const handedness = inputSource.handedness;
                    const thumbTip = inputSource.hand.get('thumb-tip');
                    const indexTip = inputSource.hand.get('index-finger-tip');

                    if (!thumbTip || !indexTip) continue;

                    const thumbPose = this.frame.getJointPose(thumbTip, this.refSpace);
                    const indexPose = this.frame.getJointPose(indexTip, this.refSpace);

                    if (!thumbPose || !indexPose) continue;

                    const pinchDistance = this._distance(thumbPose.transform.position, indexPose.transform.position);
                    const boxPos = this.el.object3D.position;

                    const midPinch = {
                        x: (thumbPose.transform.position.x + indexPose.transform.position.x) / 2,
                        y: (thumbPose.transform.position.y + indexPose.transform.position.y) / 2,
                        z: (thumbPose.transform.position.z + indexPose.transform.position.z) / 2
                    };

                    const handPos = new THREE.Vector3(midPinch.x, midPinch.y, midPinch.z);
                    const distanceToBox = handPos.distanceTo(boxPos);

                    // If pinching and close to the box, grab it
                    if (pinchDistance < this.data.distance && distanceToBox < this.data.grabRadius) {
                        if (!this.grabbingHand) {
                            this.el.object3D.position.copy(handPos);
                            this.grabbingHand = handedness;
                        } else if (this.grabbingHand === handedness) {
                            this.el.object3D.position.copy(handPos);
                        }
                    } else {
                        if (this.grabbingHand === handedness) {
                            this.grabbingHand = null;
                        }
                    }
                }
            },

            _distance: function (a, b) {
                return Math.sqrt(
                    (a.x - b.x) ** 2 +
                    (a.y - b.y) ** 2 +
                    (a.z - b.z) ** 2
                );
            }
        });
    </script>




</head>
<body>
    <div id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>

    <a-scene renderer="antialias: true"
             xr-mode-ui="enabled: true"
             webxr="optionalFeatures: hit-test, dom-overlay, local-floor, bounded-floor, layers; overlayElement: #overlay;">
        <a-box position="-0.351 0.301 -1.065"
               scale="0.2 0.2 0.2"
               material="side: double; color: #EF2D5E; transparent: true; opacity: 0.5"
               pinch-grabbable>

            <a-entity gaussian_splatting="src: Tate_0.2x.splat;"
                      position="0.157 -0.491 -0.027"
                      rotation="0 12.596 0"
                      scale="0.3 0.3 0.3">
            </a-entity>

        </a-box>


        <a-entity hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
        <a-entity hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"></a-entity>



    </a-scene>
</body>
</html>